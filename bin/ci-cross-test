#!/usr/bin/env bash
set -exuo pipefail
IFS=$'\n\t'

platforms=$(sed -n '/^PLATFORMS/,/^\].freeze/p' Rakefile | sed '1d;$d' | sed 's/^[ \t]*//')
for platform in $platforms; do
  RCD_PLATFORM="$platform"
  bundle exec rake-compiler-dock \
    bash -c \
      "sudo apt update \
      && sudo apt install sqlite3 \
      && bundle config set --local cache_all true \
      && bin/ci-push-gems \
      && bin/ci-test-project"
done
